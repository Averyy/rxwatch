name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-,suffix=-{{date 'YYYYMMDD'}},format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy to VPS
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -e

            echo "=== RxWatch Deployment ==="
            echo ""

            # ============================================
            # STEP 1: Ensure repo exists
            # ============================================
            echo "1. Checking repository..."
            if [ ! -d /root/rxwatch ]; then
              echo "   First deployment - cloning repository..."
              git clone https://github.com/${{ github.repository }}.git /root/rxwatch
            fi
            cd /root/rxwatch

            # ============================================
            # STEP 2: Check for .env.local (required)
            # ============================================
            echo "2. Checking configuration..."
            if [ ! -f .env.local ]; then
              echo ""
              echo "   ERROR: .env.local not found!"
              echo ""
              echo "   Create /root/rxwatch/.env.local with:"
              echo "   - DATABASE_URL=postgres://rxwatch:YOUR_PASSWORD@localhost:5433/rxwatch"
              echo "   - POSTGRES_PASSWORD=YOUR_PASSWORD"
              echo "   - DSC_ACCOUNTS='[{\"email\":\"...\",\"password\":\"...\"}]'"
              echo "   - CRON_SECRET=your-random-string"
              echo ""
              echo "   Then re-run this workflow."
              exit 1
            fi
            echo "   .env.local found"

            # Load environment variables for this script
            set -a
            if ! source .env.local; then
              echo "   ERROR: Failed to parse .env.local - check for syntax errors"
              exit 1
            fi
            set +a

            # Verify required vars
            if [ -z "$DATABASE_URL" ]; then
              echo "   ERROR: DATABASE_URL not set in .env.local"
              exit 1
            fi
            if [ -z "$POSTGRES_PASSWORD" ]; then
              echo "   ERROR: POSTGRES_PASSWORD not set in .env.local"
              exit 1
            fi

            # Validate DSC_ACCOUNTS is valid JSON
            if [ -n "$DSC_ACCOUNTS" ]; then
              if ! echo "$DSC_ACCOUNTS" | jq . > /dev/null 2>&1; then
                echo "   ERROR: DSC_ACCOUNTS is not valid JSON"
                exit 1
              fi
              echo "   DSC_ACCOUNTS JSON validated"
            else
              echo "   WARNING: DSC_ACCOUNTS not set - DSC sync will fail"
            fi

            echo "   Environment validated"

            # ============================================
            # STEP 3: Pull latest code
            # ============================================
            echo "3. Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # ============================================
            # STEP 4: Install dependencies (for scripts)
            # ============================================
            echo "4. Installing dependencies..."
            yarn install --frozen-lockfile

            # ============================================
            # STEP 5: Ensure Docker network exists
            # ============================================
            echo "5. Checking Docker network..."
            if ! docker network inspect web > /dev/null 2>&1; then
              echo "   Creating 'web' network for Caddy..."
              docker network create web
            fi
            echo "   Docker network ready"

            # ============================================
            # STEP 6: Start database
            # ============================================
            echo "6. Starting database..."
            docker compose -f docker-compose.prod.yml up -d db

            # Wait for database to be healthy (max 60 seconds)
            echo "   Waiting for database to be healthy..."
            for i in $(seq 1 12); do
              if docker compose -f docker-compose.prod.yml exec -T db pg_isready -U rxwatch -d rxwatch > /dev/null 2>&1; then
                echo "   Database is ready!"
                break
              fi
              if [ $i -eq 12 ]; then
                echo "   ERROR: Database failed to become healthy"
                docker compose -f docker-compose.prod.yml logs --tail=20 db
                exit 1
              fi
              echo "   Waiting... ($i/12)"
              sleep 5
            done

            # ============================================
            # STEP 7: Database setup/migration
            # ============================================
            TABLE_COUNT=$(docker compose -f docker-compose.prod.yml exec -T db psql -U rxwatch -d rxwatch -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('drugs', 'reports');" 2>/dev/null | tr -d ' ' || echo "0")

            if [ "$TABLE_COUNT" -lt 2 ]; then
              echo "7. First run detected - setting up database..."

              # Push schema
              echo "   Creating schema..."
              yarn db:push

              # Seed from cached data
              echo "   Seeding shortage history (this may take a few minutes)..."
              yarn backfill

              echo "   Seeding drug catalog..."
              yarn sync-dpd:from-cache

              echo "   First run setup complete!"
            else
              echo "7. Database exists ($TABLE_COUNT tables)"

              # Apply any schema changes
              echo "   Applying schema updates..."
              yarn db:push
            fi

            # Verify schema is ready before starting app
            echo "   Verifying schema..."
            if ! docker compose -f docker-compose.prod.yml exec -T db psql -U rxwatch -d rxwatch -c "SELECT 1 FROM drugs LIMIT 1" > /dev/null 2>&1; then
              echo "   WARNING: Could not verify drugs table - first run seeding may still be needed"
            fi

            # ============================================
            # STEP 8: Deploy app container
            # ============================================
            echo "8. Deploying app container..."
            docker compose -f docker-compose.prod.yml pull app
            docker compose -f docker-compose.prod.yml up -d

            # ============================================
            # STEP 9: Health check (wait for Docker health)
            # ============================================
            echo "9. Verifying deployment..."

            HEALTH_OK=false
            for i in $(seq 1 24); do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' rxwatch-app 2>/dev/null || echo "starting")
              if [ "$STATUS" = "healthy" ]; then
                echo "   App is healthy!"
                HEALTH_OK=true
                break
              fi
              echo "   Waiting for app... ($STATUS) ($i/24)"
              sleep 5
            done

            if [ "$HEALTH_OK" = false ]; then
              echo ""
              echo "   WARNING: Health check timed out, but container is running"
              echo ""
              docker compose -f docker-compose.prod.yml logs --tail=20 app
              # Don't fail - container may still be starting
            fi

            # ============================================
            # STEP 10: Cleanup and status
            # ============================================
            echo ""
            echo "=== Container Status ==="
            docker compose -f docker-compose.prod.yml ps

            # Keep last 3 images for rollback, prune the rest
            docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} --format "{{.ID}} {{.Tag}}" | \
              grep -v latest | tail -n +4 | awk '{print $1}' | \
              xargs -r docker rmi 2>/dev/null || true
            docker image prune -f > /dev/null 2>&1 || true

            echo ""
            echo "=== Deployment Complete ==="
            echo ""
            echo "Site: https://rxwatch.ca"

      - name: Generate deployment summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "## Deployed to VPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
